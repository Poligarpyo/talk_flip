name: iOS-ipa-build

on:
  workflow_dispatch:

jobs:
  build_ios:
    runs-on: macos-latest

    steps:
      - uses: actions/checkout@v4

      - uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.32.4'

      # ONE COMMAND TO FIX EVERYTHING
      - name: Setup compatible environment
        run: |
          # 1. Create working pubspec.yaml
          cat > pubspec.yaml << 'EOF'
          name: talkflip
          description: "A new Flutter project."
          publish_to: 'none'
          version: 1.0.0+1
          environment:
            sdk: ^3.8.1
          dependencies:
            flutter:
              sdk: flutter
            cupertino_icons: ^1.0.8
            firebase_core: ^2.24.0
            firebase_auth: ^4.11.0
            flutter_tts: ^4.1.1
            speech_to_text: ^5.6.0
            string_similarity: ^2.0.1
            dart_phonetics: ^1.0.1
            permission_handler: ^11.0.0
          dev_dependencies:
            flutter_test:
              sdk: flutter
            flutter_lints: ^5.0.0
          flutter:
            uses-material-design: true
          EOF
          
          # 2. Clean and get packages
          flutter clean
          flutter pub get
          
          # 3. Fix iOS
          cd ios
          rm -rf Pods Podfile.lock
          echo 'platform :ios, "13.0"' > Podfile
          echo 'use_modular_headers!' >> Podfile
          echo 'flutter_ios_podfile_setup' >> Podfile
          echo 'target "Runner" do' >> Podfile
          echo '  flutter_install_all_ios_pods File.dirname(File.realpath(__FILE__))' >> Podfile
          echo 'end' >> Podfile
          pod install
          cd ..

      - run: flutter build ios --release --no-codesign

      - name: Create and upload IPA
        run: |
          cd build/ios/iphoneos
          mkdir -p Payload
          mv Runner.app Payload/
          zip -r -9 FlutterIpaExport.ipa Payload
          echo "IPA created: $(pwd)/FlutterIpaExport.ipa"

      - uses: actions/upload-artifact@v4
        with:
          name: iOS-IPA
          path: build/ios/iphoneos/FlutterIpaExport.ipa
