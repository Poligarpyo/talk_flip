name: iOS-ipa-build

on:
  workflow_dispatch:

jobs:
  build-ios:
    name: ðŸŽ‰ iOS Build
    runs-on: macos-latest
    
    steps:
      - uses: actions/checkout@v3

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.32.4'

      - name: Check Flutter version
        run: flutter --version

      - name: Install CocoaPods
        run: |
          sudo gem install cocoapods
          pod --version

      - name: Prepare iOS environment
        run: |
          # Create compatible pubspec.yaml
          cat > pubspec_fixed.yaml << 'EOF'
          name: talkflip
          description: "A new Flutter project."
          publish_to: 'none'
          
          version: 1.0.0+1
          
          environment:
            sdk: ^3.8.1
          
          dependencies:
            flutter:
              sdk: flutter
            cupertino_icons: ^1.0.8
            firebase_core: ^2.32.0
            firebase_auth: ^4.16.0
            flutter_tts: ^4.1.1
            speech_to_text: ^5.6.0
            string_similarity: ^2.0.1
            dart_phonetics: ^1.0.1
            permission_handler: ^11.0.0
          
          dev_dependencies:
            flutter_test:
              sdk: flutter
            flutter_lints: ^5.0.0
          
          flutter:
            uses-material-design: true
          EOF
          
          # Use the fixed pubspec
          cp pubspec_fixed.yaml pubspec.yaml

      - name: Get dependencies
        run: |
          flutter clean
          flutter pub get

      - name: Setup iOS
        working-directory: ios
        run: |
          # Create compatible Podfile
          cat > Podfile << 'EOF'
          platform :ios, '13.0'
          use_frameworks! :linkage => :static
          
          ENV['COCOAPODS_DISABLE_STATS'] = 'true'
          
          project 'Runner', {
            'Debug' => :debug,
            'Profile' => :release,
            'Release' => :release,
          }
          
          # Flutter setup
          flutter_ios_podfile_setup
          
          target 'Runner' do
            flutter_install_all_ios_pods File.dirname(File.realpath(__FILE__))
          end
          
          post_install do |installer|
            installer.pods_project.targets.each do |target|
              target.build_configurations.each do |config|
                config.build_settings['CLANG_ALLOW_NON_MODULAR_INCLUDES_IN_FRAMEWORK_MODULES'] = 'YES'
                config.build_settings['ENABLE_BITCODE'] = 'NO'
                config.build_settings['IPHONEOS_DEPLOYMENT_TARGET'] = '13.0'
                config.build_settings['BUILD_LIBRARY_FOR_DISTRIBUTION'] = 'YES'
              end
            end
            installer.pods_project.build_configurations.each do |config|
              config.build_settings['EXCLUDED_ARCHS[sdk=iphonesimulator*]'] = 'arm64'
            end
          end
          EOF
          
          # Install pods
          pod deintegrate 2>/dev/null || true
          rm -rf Pods Podfile.lock
          pod repo update
          pod install --repo-update

      - name: Build iOS
        run: |
          flutter clean
          flutter build ios --release --no-codesign --verbose

      - name: Create IPA
        run: |
          cd build/ios/iphoneos
          mkdir -p Payload
          mv Runner.app Payload/
          zip -r -9 FlutterIpaExport.ipa Payload

      - name: Upload IPA
        uses: actions/upload-artifact@v3
        with:
          name: iOS-IPA-Build
          path: build/ios/iphoneos/FlutterIpaExport.ipa
          retention-days: 7
