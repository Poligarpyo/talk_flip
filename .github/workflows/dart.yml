name: iOS-ipa-build

on:
  workflow_dispatch:

jobs:
  build_ios:
    runs-on: macos-latest

    steps:
      - uses: actions/checkout@v4

      - uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.32.4'

      - name: Use compatible plugin versions
        run: |
          # Create compatible pubspec.yaml
          cat > pubspec.yaml << 'EOF'
          name: talkflip
          description: "A new Flutter project."
          publish_to: 'none'
          version: 1.0.0+1
          environment:
            sdk: ^3.8.1
          dependencies:
            flutter:
              sdk: flutter
            cupertino_icons: ^1.0.8
            firebase_core: ^2.24.0
            firebase_auth: ^4.11.0
            flutter_tts: ^4.1.1
            speech_to_text: ^5.6.0
            string_similarity: ^2.0.1
            dart_phonetics: ^1.0.1
            permission_handler: ^11.0.0
          dev_dependencies:
            flutter_test:
              sdk: flutter
            flutter_lints: ^5.0.0
          flutter:
            uses-material-design: true
          EOF

      - name: Clean and get packages
        run: |
          flutter clean
          flutter pub get

      - name: Let Flutter regenerate iOS
        run: |
          rm -rf ios
          flutter create --platforms=ios --org com.example --project-name talkflip .
          
          # Add use_modular_headers! to Podfile
          cd ios
          sed -i '' '/target .Runner. do/a\
  use_modular_headers!' Podfile

      - name: Install iOS dependencies
        working-directory: ios
        run: |
          pod repo update
          pod install --repo-update

      - run: flutter build ios --release --no-codesign

      - name: Create and upload IPA
        run: |
          cd build/ios/iphoneos
          mkdir -p Payload
          mv Runner.app Payload/
          zip -r -9 FlutterIpaExport.ipa Payload

      - uses: actions/upload-artifact@v4
        with:
          name: iOS-IPA
          path: build/ios/iphoneos/FlutterIpaExport.ipa
